# Background Subtraction Intensity Analysis Integration Guide

## Overview

This integration automates the 4-script workflow previously required for the `Intensityanalysisbs` plugin. The workflow now runs automatically within percell, eliminating manual editing and execution of separate scripts.

## What Was Integrated

### Previous Manual Workflow
1. **copy_masks_and_raw.sh**: Copy files from percell analysis to BS directory
2. **PB_Macro.ijm**: Process P-body data in ImageJ
3. **SG_Macro.ijm**: Process stress granule data in ImageJ
4. **copy_ch0_to_processed.sh**: Copy ch0 files to final directories

### New Automated Solution
All 4 steps are now integrated into a single plugin with automatic execution.

## New Components

### 1. Domain Service ([bs_preprocessing_service.py](percell/domain/services/bs_preprocessing_service.py))
Pure Python service handling file operations:
- `prepare_bs_directory()`: Creates BS directory structure and copies masks/raw data
- `copy_ch0_to_processed()`: Copies ch0 files with proper naming conventions
- `extract_condition_from_filename()`: Parses percell filename conventions
- `get_conditions_from_masks()`: Extracts unique condition identifiers

### 2. ImageJ Macros
Automated versions of the original macros (no user interaction required):
- [pb_background_subtraction.ijm](percell/macros/pb_background_subtraction.ijm): P-body processing
- [sg_background_subtraction.ijm](percell/macros/sg_background_subtraction.ijm): Stress granule processing

These macros:
- Accept directory path as argument (no GUI prompts)
- Process all conditions automatically
- Output to `Processed/` directory with correct naming conventions
- Report progress for integration with percell's progress bars

### 3. Workflow Orchestrator ([bs_workflow.py](percell/application/bs_workflow.py))
Application-level service coordinating the full workflow:
- Manages execution order
- Handles errors and logging
- Provides progress updates
- Locates and executes ImageJ macros

### 4. Enhanced Plugin ([intensity_analysis_with_preprocessing_plugin.py](percell/plugins/intensity_analysis_with_preprocessing_plugin.py))
New plugin combining preprocessing + analysis:
- Prompts for percell analysis directory
- Validates directory structure
- Runs preprocessing automatically
- Executes intensity analysis on processed data
- Reports results

## How to Use

### From Percell CLI

1. Launch percell
2. Select "Intensity Analysis BS (Auto-Prep)" from plugin menu
3. When prompted, provide:
   - Path to percell analysis directory (must contain `combined_masks/` and `raw_data/`)
   - Confirm condition mapping (default: "1Hr_NaAsO2" and "Untreated")
   - Confirm output directory (default: `{analysis_dir}_BS`)
4. The plugin will:
   - Copy files to BS directory structure
   - Run P-body ImageJ macro
   - Run stress granule ImageJ macro
   - Copy ch0 files
   - Run intensity analysis
   - Generate CSV results and histograms

### Programmatic Usage

```python
from pathlib import Path
from percell.domain.services.bs_preprocessing_service import BSPreprocessingService
from percell.application.bs_workflow import BSWorkflow
from percell.adapters.imagej_macro_adapter import ImageJMacroAdapter
from percell.domain.services.package_resource_service import PackageResourceService
import percell

# Initialize services
preprocessing_service = BSPreprocessingService()
package_root = Path(percell.__file__).parent
resource_service = PackageResourceService(package_root=package_root)
imagej_adapter = ImageJMacroAdapter(Path("/path/to/ImageJ"))

# Create workflow orchestrator
workflow = BSWorkflow(
    preprocessing_service,
    imagej_adapter,
    resource_service
)

# Run full preprocessing
percell_analysis_dir = Path("/path/to/percell/analysis")
bs_dir = workflow.run_full_preprocessing(
    percell_analysis_dir,
    condition_map={"1Hr_NaAsO2": "1Hr_NaAsO2", "Untreated": "Untreated"}
)

print(f"Preprocessing complete! Output: {bs_dir}")
```

## Directory Structure

### Input (Percell Analysis Directory)
```
my_analysis/
├── combined_masks/
│   ├── MASK_MAX_z-stack_1Hr_NaAsO2_Merged_ch1_t00.tif
│   ├── MASK_MAX_z-stack_1Hr_NaAsO2_Merged_ch2_t00.tif
│   └── ...
└── raw_data/
    ├── MAX_z-stack_1Hr_NaAsO2_Merged_ch0_t00.tif
    ├── MAX_z-stack_1Hr_NaAsO2_Merged_ch1_t00.tif
    ├── MAX_z-stack_1Hr_NaAsO2_Merged_ch2_t00.tif
    └── ...
```

### Output (BS Directory)
```
my_analysis_BS/
├── Masks/              # Copied from combined_masks
│   └── *.tif
├── Raw Data/           # Copied from raw_data (ch1, ch2)
│   └── *.tif
└── Processed/          # Generated by ImageJ macros
    ├── 1Hr_NaAsO2/
    │   ├── 1Hr_NaAsO2_PB_Mask.zip
    │   ├── 1Hr_NaAsO2_PB_Dilated_Mask.zip
    │   ├── 1Hr_NaAsO2_DDX6_Intensity.tif
    │   ├── 1Hr_NaAsO2_SG_Mask.zip
    │   ├── 1Hr_NaAsO2_SG_Dilated_Mask.zip
    │   ├── 1Hr_NaAsO2_G3BP1_Intensity.tif
    │   ├── 1Hr_NaAsO2_Cap_Intensity.tif     # From ch0
    │   ├── 1Hr_NaAsO2_PB_Cap_intensity_analysis.csv
    │   ├── 1Hr_NaAsO2_DDX6_intensity_analysis.csv
    │   └── ...
    └── Untreated/
        └── ...
```

## Configuration

### Required Settings
- **ImageJ path**: Must be configured in percell settings
  - The plugin will use the ImageJ adapter from the container
  - Set via percell config or environment

### Optional Settings
- **Condition mapping**: Customize how ch0 files are mapped to conditions
  - Default: `{"1Hr_NaAsO2": "1Hr_NaAsO2", "Untreated": "Untreated"}`
  - Can be customized when running the plugin

## File Naming Conventions

The integration expects percell's standard naming conventions:

### Mask Files
- Format: `MASK_MAX_z-stack_{condition}_Merged_ch{X}_t00.tif`
- Example: `MASK_MAX_z-stack_1Hr_NaAsO2_Merged_ch1_t00.tif`

### Raw Data Files
- Format: `MAX_z-stack_{condition}_Merged_ch{X}_t00.tif`
- Example: `MAX_z-stack_Untreated_Merged_ch2_t00.tif`

### Output Files (Generated)
- ROI masks: `{condition}_{PB|SG}_Mask.zip`
- Dilated ROIs: `{condition}_{PB|SG}_Dilated_Mask.zip`
- Intensity images: `{condition}_{DDX6|G3BP1|Cap}_Intensity.tif`
- Analysis results: `{condition}_{PB_Cap|DDX6|SG_Cap|G3BP1}_intensity_analysis.csv`

## Customization

### Adding New Conditions
To support additional conditions beyond "1Hr_NaAsO2" and "Untreated":

```python
condition_map = {
    "pattern_in_filename": "condition_name",
    "2Hr_Treatment": "2Hr_Treatment",
    "Control": "Control",
}
```

### Adjusting ROI Dilation
P-body ROIs are enlarged by 2 pixels, stress granules by 5 pixels. To modify:

Edit the macros:
- [pb_background_subtraction.ijm](percell/macros/pb_background_subtraction.ijm#L100): Change `enlarge=2`
- [sg_background_subtraction.ijm](percell/macros/sg_background_subtraction.ijm#L100): Change `enlarge=5`

### Custom Analysis Configurations
The intensity analysis uses 4 standard configurations:
1. **PB_Cap**: P-body Cap intensity
2. **DDX6**: P-body DDX6 intensity
3. **SG_Cap**: Stress granule Cap intensity
4. **G3BP1**: Stress granule G3BP1 intensity

These can be customized through the plugin's configuration prompts.

## Troubleshooting

### "ImageJ adapter not available"
- Ensure ImageJ is configured in your percell settings
- Check that ImageJ executable path is correct
- Verify ImageJ can run in batch mode

### "combined_masks directory not found"
- Ensure you're pointing to a percell analysis output directory
- The directory must have been processed by percell's segmentation pipeline

### "Could not determine condition for file"
- Check filename format matches expected conventions
- Customize condition_map to match your naming patterns

### "Skipping X - missing files"
- Ensure all required channels (ch0, ch1, ch2) are present
- Check that mask files exist for both ch1 and ch2

## Architecture

This integration follows percell's hexagonal architecture:

- **Domain layer**: `BSPreprocessingService` - Pure business logic
- **Application layer**: `BSWorkflow` - Orchestration and coordination
- **Adapter layer**: Uses existing `ImageJMacroAdapter` for ImageJ integration
- **Plugin layer**: `IntensityAnalysisBSAutoPlugin` - User interface

## Testing

To test the integration:

```bash
# Run with a sample percell analysis directory
python -m percell plugins run intensity_analysis_bs_auto \
  --input /path/to/percell/analysis

# Or use the percell CLI interactively
python -m percell
# Then select: Intensity Analysis BS (Auto-Prep)
```

## Migration from Manual Scripts

If you were previously using the manual 4-script workflow:

1. **No changes needed** to your percell analysis outputs
2. **No manual editing** of file paths required
3. **No manual execution** of separate scripts
4. Same output format and structure
5. Same analysis results

The new plugin produces identical results to the manual workflow but automates all steps.

## Performance

- File copying is fast (uses shutil.copy2 for metadata preservation)
- ImageJ macros run in batch mode (no GUI overhead)
- Progress is reported in real-time
- Typical runtime: 1-3 minutes per analysis directory (depends on dataset size)

## Future Enhancements

Potential improvements:
- [ ] Parallel processing of multiple conditions
- [ ] Custom dilation parameters via configuration
- [ ] Support for additional channels beyond ch0/ch1/ch2
- [ ] Validation of output files
- [ ] Resume capability for interrupted runs
- [ ] Export of preprocessing parameters to JSON
